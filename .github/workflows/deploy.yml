name: Simple API CI/CD

on:
  push:
    branches:
      - main
  repository_dispatch:
    types: [deploy_approved]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Build jar
        run: ./gradlew bootJar --no-daemon

      - name: Notify Progress 25%
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*üöÄ Deploy Started* by ${{ github.actor }}\nüü©‚¨úÔ∏è‚¨úÔ∏è‚¨úÔ∏è Build Complete"
                }
              }
            ]
          }' \
          $SLACK_WEBHOOK_URL
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Extract metadata (tags)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Notify Progress 50%
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*üê≥ Docker Image Pushed*\nüü©üü©‚¨úÔ∏è‚¨úÔ∏è Deploying..."
                }
              }
            ]
          }' \
          $SLACK_WEBHOOK_URL
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:

      # 1. Slack ÏäπÏù∏ Î≤ÑÌäº Ï†ÑÏÜ°
#      - name: Request deploy approval
#        run: |
#          curl -X POST -H 'Content-type: application/json' \
#          --data '{
#            "blocks": [
#              {
#                "type": "header",
#                "text": {
#                  "type": "plain_text",
#                  "text": "üöÄ Î∞∞Ìè¨ ÏäπÏù∏ ÏöîÏ≤≠"
#                }
#              },
#              {
#                "type": "section",
#                "text": {
#                  "type": "mrkdwn",
#                  "text": "*${{ github.actor }}* ÎãòÏù¥ Î∞∞Ìè¨Î•º ÏöîÏ≤≠ÌñàÏäµÎãàÎã§.\nÏäπÏù∏ÌïòÏãúÍ≤†ÏäµÎãàÍπå?"
#                }
#              },
#              {
#                "type": "actions",
#                "elements": [
#                  {
#                    "type": "button",
#                    "text": { "type": "plain_text", "text": "‚úî ÏäπÏù∏" },
#                    "style": "primary",
#                    "value": "approve_deploy"
#                  },
#                  {
#                    "type": "button",
#                    "text": { "type": "plain_text", "text": "‚ùå Ï∑®ÏÜå" },
#                    "style": "danger",
#                    "value": "reject_deploy"
#                  }
#                ]
#              }
#            ]
#          }' \
#          $SLACK_WEBHOOK_URL
#        env:
#          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      # 2. ÏäπÏù∏ ÎåÄÍ∏∞
#      - name: Wait for approval
#        run: |
#          echo "‚è≥ Î∞∞Ìè¨ ÏäπÏù∏ ÎåÄÍ∏∞ Ï§ë..."
#          for i in {1..30}
#          do
#            echo "Waiting... ($i/30)"
#            sleep 10
#          done
#          echo "‚ö† ÏäπÏù∏ Ïã†Ìò∏(deploy_approved)Í∞Ä Ïò§ÏßÄ ÏïäÏïòÏäµÎãàÎã§."
#          exit 1

      - name: Notify Progress 75%
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*üö¢ Deploying to EC2*\nüü©üü©üü©‚¨úÔ∏è Running health check..."
                }
              }
            ]
          }' \
          $SLACK_WEBHOOK_URL
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: SSH to AWS EC2 and deploy container
        uses: appleboy/ssh-action@v0.1.10
        env:
          GHCR_TOKEN: ${{ secrets.GHCR_PAT }}
          GHCR_USER: ${{ github.actor }}
          IMAGE_REPO: ghcr.io/${{ github.repository }}
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_SSH_KEY }}
          envs: GHCR_TOKEN,GHCR_USER,IMAGE_REPO
          script: |
            set -e

            echo "üìÅ Creating necessary directories..."
            mkdir -p ~/feedback-api/{data,logs}
            cd ~/feedback-api

            echo "üîê Logging in to GitHub Container Registry..."
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USER" --password-stdin

            echo "üìù Creating docker-compose.yml..."
            cat > docker-compose.yml << 'EOF'
            version: "3.8"

            services:
              feedback-api:
                image: ghcr.io/${{ github.repository }}:latest
                container_name: feedback-api
                ports:
                  - "8080:8080"
                volumes:
                  - ./data:/app/data
                  - ./logs:/app/logs
                environment:
                  - SPRING_PROFILES_ACTIVE=prod
                  - JAVA_OPTS=-Xmx512m -Xms256m
                  - SPRING_DATASOURCE_URL=jdbc:h2:file:/app/data/feedbackdb
                  - LOGGING_FILE_NAME=/app/logs/feedback-api.log
                restart: unless-stopped
                healthcheck:
                  test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 40s
            EOF

            echo "üì¶ Pulling latest image..."
            docker pull "$IMAGE_REPO:latest"

            echo "üõë Stopping old containers..."
            docker compose down || true

            echo "üöÄ Starting new container with docker-compose..."
            docker compose up -d

            echo "‚è± Waiting for app to start..."
            sleep 40

            echo "ü©∫ Running health check..."
            if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
              echo "‚úÖ Deployment succeeded!"
              echo "üìä Container status:"
              docker compose ps
              echo "üíæ Data directory:"
              ls -lh data/

              echo "üîì Logging out from GHCR..."
              docker logout ghcr.io
            else
              echo "‚ùå Deployment failed! Checking logs..."
              docker compose logs --tail=50
              echo "üîÑ Rolling back..."
              docker compose down
              docker logout ghcr.io
              exit 1
            fi

      - name: Notify deploy success
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*‚úÖ Deploy Complete*\nüü©üü©üü©üü© Live on Production"
                }
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "mrkdwn",
                    "text": "<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>"
                  }
                ]
              }
            ]
          }' \
          $SLACK_WEBHOOK_URL
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify deploy failure
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*üö® Deploy Failed*\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|Check Logs Now>"
                }
              }
            ]
          }' \
          $SLACK_WEBHOOK_URL
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}