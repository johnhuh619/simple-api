name: Simple API CI/CD
# Í∏∞Î≥∏ Î∞∞Ìè¨Ïù¥ÎπàÎã§
on:
  push:
    branches:
      - main
  repository_dispatch:
    types: [deploy_approved]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Build jar
        run: ./gradlew bootJar --no-daemon

      - name: Notify Progress 25%
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*üöÄ Deploy Started* by ${{ github.actor }}\nüü©‚¨úÔ∏è‚¨úÔ∏è‚¨úÔ∏è Build Complete"
                }
              }
            ]
          }' \
          $SLACK_WEBHOOK_URL
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Save current latest as previous
        continue-on-error: true
        run: |
          # Pull current latest image
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest || echo "No previous image found"

          # Re-tag as previous
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:previous || echo "Skipping tag"

          # Push previous tag
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:previous || echo "Skipping push"

      - name: Extract metadata (tags)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Notify Progress 50%
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*üê≥ Docker Image Pushed*\nüü©üü©‚¨úÔ∏è‚¨úÔ∏è Deploying..."
                }
              }
            ]
          }' \
          $SLACK_WEBHOOK_URL
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Notify Progress 75%
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*üö¢ Deploying to EC2*\nüü©üü©üü©‚¨úÔ∏è Running health check..."
                }
              }
            ]
          }' \
          $SLACK_WEBHOOK_URL
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: SSH to AWS EC2 and deploy container
        uses: appleboy/ssh-action@v0.1.10
        env:
          GHCR_TOKEN: ${{ secrets.GHCR_PAT }}
          GHCR_USER: ${{ github.actor }}
          IMAGE_REPO: ghcr.io/${{ github.repository }}
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_SSH_KEY }}
          envs: GHCR_TOKEN,GHCR_USER,IMAGE_REPO
          script: |
            set -e

            echo "üìÅ Preparing deployment directory..."
            mkdir -p ~/feedback-api
            cd ~/feedback-api

            echo "üîÑ Ensuring Docker volumes exist..."
            docker volume create feedback-data 2>/dev/null || true
            docker volume create feedback-logs 2>/dev/null || true

            echo "üîê Logging in to GitHub Container Registry..."
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USER" --password-stdin

            echo "üìù Creating docker-compose.yml..."
            cat > docker-compose.yml << 'EOF'
            version: "3.8"

            services:
              feedback-api:
                image: ghcr.io/${{ github.repository }}:latest
                container_name: feedback-api
                ports:
                  - "8080:8080"
                volumes:
                  - ./data:/app/data
                environment:
                  - SPRING_PROFILES_ACTIVE=prod
                  - JAVA_OPTS=-Xmx512m -Xms256m
                restart: unless-stopped
                logging:
                  driver: awslogs
                  options:
                    awslogs-region: ap-northeast-2
                    awslogs-group: /ecs/feedback-api
                    awslogs-stream: feedback-api
                    awslogs-create-group: "true"
                healthcheck:
                  test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 40s
            EOF

            echo "üíæ Backing up database from Docker volume..."
            BACKUP_DIR=~/feedback-api/backups
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_FILE="feedbackdb_$TIMESTAMP.mv.db"
            mkdir -p $BACKUP_DIR

            # Docker volumeÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î≥µÏÇ¨
            # ÏûÑÏãú Ïª®ÌÖåÏù¥ÎÑàÎ•º ÏÇ¨Ïö©ÌïòÏó¨ volume Îç∞Ïù¥ÌÑ∞Ïóê Ï†ëÍ∑º
            docker run --rm \
              -v feedback-data:/data:ro \
              -v $BACKUP_DIR:/backup \
              alpine \
              sh -c "if [ -f /data/feedbackdb.mv.db ]; then cp /data/feedbackdb.mv.db /backup/$BACKUP_FILE; echo 'copied'; else echo 'not found'; fi" > /tmp/backup_result.txt

            if grep -q "copied" /tmp/backup_result.txt; then
              echo "‚úÖ Database backed up to $BACKUP_DIR/$BACKUP_FILE"

              # S3 ÏóÖÎ°úÎìú (EC2 IAM Role ÏÇ¨Ïö©)
              echo "‚òÅÔ∏è Uploading backup to S3..."
              aws s3 cp "$BACKUP_DIR/$BACKUP_FILE" \
                "s3://feedback-api-backups-396468676673/$(date +%Y/%m/%d)/$BACKUP_FILE" \
                --region ap-northeast-2 \
                --storage-class STANDARD_IA

              if [ $? -eq 0 ]; then
                echo "‚úÖ Backup uploaded to S3"
              else
                echo "‚ö†Ô∏è S3 upload failed, but local backup exists"
              fi

              # Î°úÏª¨ Î∞±ÏóÖ: 7Ïùº Ïù¥ÏÉÅ Îêú Í≤ÉÎßå ÏÇ≠Ï†ú (S3ÏóêÎäî ÏûàÏúºÎØÄÎ°ú)
              find $BACKUP_DIR -name "feedbackdb_*.mv.db" -mtime +7 -delete
            else
              echo "‚ö†Ô∏è No database found in volume, skipping backup"
            fi

            echo "üì¶ Pulling latest image..."
            docker pull "$IMAGE_REPO:latest"

            echo "üõë Stopping old containers..."
            docker compose down || true

            echo "üöÄ Starting new container with docker-compose..."
            docker compose up -d

            echo "‚è± Waiting for app to start..."
            sleep 40

            echo "ü©∫ Running health check..."
            if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
              echo "‚úÖ Deployment succeeded!"
              echo "üìä Container status:"
              docker compose ps
              echo "üíæ Data directory:"
              ls -lh data/

              echo "üîì Logging out from GHCR..."
              docker logout ghcr.io
            else
              echo "‚ùå Deployment failed! Checking logs..."
              docker compose logs --tail=50
              echo "üîÑ Rolling back..."
              docker compose down
              docker logout ghcr.io
              exit 1
            fi

      - name: Notify deploy success
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*‚úÖ Deploy Complete*\nüü©üü©üü©üü© Live on Production"
                }
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "mrkdwn",
                    "text": "<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>"
                  }
                ]
              }
            ]
          }' \
          $SLACK_WEBHOOK_URL
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify deploy failure
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*üö® Deploy Failed*\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|Check Logs Now>"
                }
              }
            ]
          }' \
          $SLACK_WEBHOOK_URL
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}